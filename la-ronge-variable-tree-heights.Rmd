---
title: "La Ronge Tree Heights"
author: "SMurphy"
date: "2023-10-15"
output: 
  github_document:
    toc: TRUE
    toc_depth: 5
    number_sections: FALSE
    df_print: tibble
---

```{r setup, echo=FALSE, message=FALSE,warning=FALSE, error=FALSE}
library(sf)
library(RColorBrewer)
library(lidR)
library(ForestTools)
library(rgl)
library(pandocfilters)
library(rmarkdown)
library(formatR)
library(gitignore)
library(tinytex)
library(knitr)
library(raster)
library(webdriver)
library(webshot)
library(webshot2)
library(terra)
library(matlab)
library(spatstat.geom)
library(magic)
library(geometry)
library(deldir)
library(bitops)
library(rLiDAR)
#webshot::install_phantomjs(force = TRUE)
knit_hooks$set(webgl = hook_webgl)
knit_hooks$set(rgl.static = hook_rgl)
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, error=FALSE, message = FALSE)
set.seed(23)
```

# Tree Height Variability

We apply the “Height Variation Hypothesis” and associated methods to estimate tree height heterogeneity. Using these outputs, we classifiy forest areas by such heterogeneity. The end goals is to assist ground crews in inventory operations to identify areas where increased number of sample plots or smaller sampling units area needed.


## Data Source

A digital surface model and digital elevation model were acquired in raster form and with 1m resolution from the HRDEM repository for the La Ronge surrounding area, as shown in the following location: https://open.canada.ca/data/en/dataset/957782bf-847c-4644-a757-e383c0057995/resource/83300867-10b0-4c9d-a2b6-3921f2a07dcb#additional-info

```{r, rgl.static=TRUE, cache=TRUE, eval=TRUE, echo=TRUE}
dsm = raster::raster("/media/seamus/USB1/la_ronge/dsm_la_ronge.tif", select = 'xyzcr', filter = '-drop_class 19')
dem = raster::raster("/media/seamus/USB1/la_ronge/dem_la_ronge.tif", select = 'xyzcr', filter = '-drop_class 19')
dsm_sr = terra::rast(dsm)
dem_sr = terra::rast(dem)
chm_sr = dsm_sr - dem_sr
chm = raster::raster(chm_sr)
plot(dsm_sr, main="DSM (metres a.s.l.)", cex.main=0.8, maxpixels=22000000)
plot(dem_sr, main="DEM (metres a.s.l.)", cex.main=0.8, maxpixels=22000000)
plot(chm_sr, main="CHM (unprocessed)", cex.main=0.8, maxpixels=22000000)
```

## Tree top detection 

We adopt below Popescu and Wynne's function (2004) which was developed in spruce forests to define a variable window filter for detecting tree tops. This is to account for variance in Dominant, co-dominant, intermediate, and suppressed trees, which haveboth varying heights and varying crown widths. We assume taller trees have wider crowns. Therefore, we apply a simple linear function (wf_Popescu) to adapt the radius of the search window according to canopy height. With more resources available, a local radius to height curve can be derived from the site's dominant allometry. 

To exclude low-lying underbrush or other spurious treetops, the variable window function is also set with a minimum height of 2 m using the minHeight argument as follows. 

```{r, echo=TRUE, eval=TRUE}
kernel <- matrix(1,3,3)
wf_Popescu<-function(x){ 
  a=0.05
  b=0.6 
  y<-a*x+b 
  return(y)}
heights <- seq(0,40,0.5)
window_Popescu <- wf_Popescu(heights)
plot(heights, window_Popescu, type = "l", ylim = c(0,12), xlab="point elevation (m)", ylab="window diameter (m)", main='Variable Window Function (Popescu & Wynne 2004)')
```

To improve algorithm performance, we apply a smoothing operation to our DSM raster. With cells softened, we then apply the upside-down watershed algorithm from the ForestTools package, shown as vwf below. Outputs are then converted from simple features to derive 95% height raster and stem point shapefile in ESRI format using a custom function.   

```{r, echo=TRUE, eval=TRUE}
chm_smooth = focal(chm, w = kernel, fun = median, na.rm = TRUE) 
ttops = ForestTools::vwf(CHM = chm_smooth, winFun = wf_plowright, minHeight = 2)

ttops$height_95 = ttops$height
ttops$height_95 = ttops$height_95 * 0.95
ttops_df = as.data.frame(ttops)

ttops_FCAS <- ttops_df %>%
    mutate(long = unlist(map(ttops_df$geometry,1)),
           lat = unlist(map(ttops_df$geometry,2)))

df <- df %>%
  dplyr::mutate(lon = sf::st_coordinates(.)[,1],
                lat = sf::st_coordinates(.)[,2])

ttops_df = select(ttops_df,geometry, height_95)
#chm_rr <- ForestTools::sp_summarise(ttops, grid = 1, variables = "height", statFuns = custFuns)
writeRaster(chm_rr, filename = "/media/seamus/USB1/la_ronge/chm_rr.tif", overwrite=TRUE)
#chm_sp = as_Spatial(chm)
#writeOGR(chm_sp, "/media/seamus/USB1/la_ronge", "chm", driver = "ESRI Shapefile") ##deprecated
st_write(ttops, "/media/seamus/USB1/la_ronge/chm_la_ronge.shp")

plot(chm_rr, col = height.colors(50))
plot(sf::st_geometry(chm_sf), pch = 3, add=TRUE)
```

## Validation

Results are validated using tree-ID and crown segmentation. These steps check for double-counting and overlapping edges. 

```{r, echo=TRUE, eval=TRUE}
sCHM<-CHMsmoothing(chm, filter="mean", ws=5) # smoothing CHM
loc<-FindTreesCHM(sCHM, fws=5, minht=8)      # or import a tree list

# Set the maxcrown parameter
maxcrown=10.0 

# Set the exclusion parameter
exclusion=0.3 # 30

# Compute individual tree detection canopy area
canopy<-ForestCAS(chm, loc, maxcrown, exclusion)

#==================================================================================#
# Retrieving the boundary for individual tree detection and canopy area calculation
#==================================================================================#
boundaryTrees<-canopy[[1]]
# Plotting the individual tree canopy boundary over the CHM
plot(chm, main="LiDAR-derived CHM") 
 
# adding tree canopy boundary
plot(boundaryTrees, add = TRUE, border = 'red', bg = 'transparent')```
